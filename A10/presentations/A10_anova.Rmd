---
title: 'Science des données : module 10'
subtitle:  \includegraphics[width=.08\textwidth,height=.1\textheight]{../../template/biodatascience.png}
  \includegraphics[width=.08\textwidth,height=.1\textheight]{../../template/SciViews-logo.pdf} \vfill ANOVA
author: Philippe Grosjean & Guyliann Engels
institute: Université de Mons, Belgique\break Laboratoire d'Écologie numérique des Milieux aquatiques\break \includegraphics[width=.08\textwidth,height=.1\textheight]{../../template/EcoNum-logo.pdf} \break \url{http://biodatascience-course.sciviews.org} \break \url{sdd@sciviews.org}
date: ''
fontfamily: mathpazo
fontsize: 9pt
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
SciViews::R
```


### Objectifs du cours

\putat{200}{-30}{\includegraphics[width=50mm]{../../template/resources.pdf}}

 - Se rappeler le principe de l'ANOVA à 1 facteur
 
 - Etendre à un modèle à 2 facteurs
 
 - Déterminer les différents types de modèes à 2 facteurs et choisir l'analyse correspondante


# ANOVA à un facteur

### ANOVA à un facteur - Rappel 1

- Les tests de Student sont limités à la comparaison de **deux** variables quantitatives (deux échantillons indépendants).

- **Comment comparer les moyennes de plus de deux échantillons simultanément ?**

- En faisant autant de tests de Student qu’il y a de couples de moyennes à comparer, **le risque de se tromper dans \alert{au moins} une de ces comparaisons vaut :**

|échantillons  |  2  |  3  |  4  |  6  |  8  |  10 |
|:-------------|:---:|:---:|:---:|:---:|:---:|:---:|
|risque $\alpha$ = 5% |  5% | 12% | 20% | 37% | 51% | 63% |

**=> Il faut travailler différemment : \alert{ANOVA (ANalysis Of VAriance)}**


### ANOVA à un facteur - Rappel 2

- Hypothèses:

$$
\begin{aligned}
\textrm{H}_0&: \mu_1=\mu_2=...=\mu_p\\
\textrm{H}_1&: \textrm{au moins une moyenne est différente}
\end{aligned}
$$

\columnsbegin
\columnsmall

- \alert{Décomposition de la variance}

Comme pour la variance, les parts de variance _inter_ et _intra_ se calculent par la somme des carrés des distances divisées par les ddl.

\columnlarge


```{r, fig.width = 4.5, fig.height = 3, echo = FALSE, message = FALSE, warning = FALSE}
dat <- data.frame(Population = c("A", "A", "A", "B", "B", "B", "C", "C", "C"),
  Réponse = c(2.2, 2.4, 3.3, 4.9, 5.2, 6.1, 4.3, 6.4, 6.5))
means <- c(mean(dat$Réponse), tapply(dat$Réponse, dat$Population, mean))
annot <- data.frame(x = c(1.1, 1.4, 1.7, 2.1, 2.4, 2.7),
  ystart = c(means[1], means[1], means[2], means[1], means[1], means[3]),
  yend = c(2.2, means[2], 2.2, 4.9, means[3], 4.9),
  color = c(2L, 2L, 2L, 3L, 3L, 3L))
annot2 <- data.frame(xstart = c(0.95, 1.95), xend = c(1.75, 2.75),
  y = c(2.2, 4.9), color = 2:3)
library(ggplot2)
pl <- ggplot(dat) +
  geom_point(mapping = aes(x = Population, y = Réponse, col = Population)) +
  theme(legend.position = "none") +
  geom_hline(yintercept = means, col = 1:4, linetype = "dashed", size = 0.5) +
  geom_segment(data = annot2, aes(x = xstart, xend = xend, y = y , yend = y),
    color = annot2$color, linetype = "dotted", size = 0.5) +
  geom_segment(data = annot, aes(x = x, xend = x, y = ystart, yend = yend),
    color = annot$color, size = 0.5, arrow = arrow(length = unit(0.2, "cm"))) +
  annotate("text", x = 1, y = means[1] + 0.2, color = 1,
    label = "moyenne générale") +
  annotate("text", x = 3.1, y = means[2] + 0.2, color = 2,
    label = "moyenne pour A") +
  annotate("text", x = 3.1, y = means[3] + 0.2, color = 3,
    label = "moyenne pour B") +
  annotate("text", x = 3.1, y = means[4] + 0.2, color = 4,
    label = "moyenne pour C") +
  annotate("text", x = 1.25, y = 3.25, color = 2, label = "total") +
  annotate("text", x = 1.55, y = 3.6, color = 2, label = "inter") +
  annotate("text", x = 1.85, y = 2.5, color = 2, label = "intra") +
  annotate("text", x = 2.25, y = 4.8, color = 3, label = "total") +
  annotate("text", x = 2.55, y = 5.1, color = 3, label = "inter") +
  annotate("text", x = 2.85, y = 5.2, color = 3, label = "intra")
plot(pl)
```

```{r eval=FALSE, include=FALSE}
# Version en graphique de base de R (non utilisée ici)
x <- rep(1:3, each = 3)
y <- c(2.1, 2.4, 3.5, 4, 4.5, 5.9, 4.7, 5, 5.6)

Mtot <- mean(y)
Ma <- mean(y[1:3])
Mb <- mean(y[4:6])
Mc <- mean(y[7:9])

plot(x, y, pch = 19, col = rep(2:4, each = 3), ylim = c(2, 6),
	xaxt = "none", xlab = "Facteur", ylab = "Réponse")
axis(1, at = 1:3, labels = c("A", "B", "C"))  

abline(h = Mtot, col = 1, lty = 2, lwd = 2)
abline(h = Ma, col = 2, lty = 2)
abline(h = Mb, col = 3, lty = 2)
abline(h = Mc, col = 4, lty = 2)

# Traits représentant les différentes composantes
lines(c(1, 1.7), c(2.4, 2.4), col = 2, lty = 3)
arrows(1.03, 2.4, 1.03, Mtot, col = 2, code = 3, length = 0.1, lwd = 2)
arrows(1.33, Ma, 1.33, Mtot, col = 2, code = 3, length = 0.1, lwd = 2)
arrows(1.63, 2.4, 1.63, Ma, col = 2, code = 3, length = 0.1, lwd = 2)
text(c(1.03, 1.33, 1.63), c(3.25, 3.35, 2.55), c("total", "inter", "intra"),
	cex = 1, col = 2, pos = 4)

lines(c(2, 2.7), c(4.5, 4.5), col = 3, lty = 3)
arrows(2.03, 4.5, 2.03, Mtot, col = 3, code = 3, length = 0.1, lwd = 2)
arrows(2.33, Mb, 2.33, Mtot, col = 3, code = 3, length = 0.1, lwd = 2)
arrows(2.63, 4.5, 2.63, Mb, col = 3, code = 3, length = 0.1, lwd = 2)
text(c(2.03, 2.33, 2.63), c(4.35, 4.5, 4.65), c("total", "inter", "intra"),
	cex = 1, col = 3, pos = 4)

text(1, 4.31, "moyenne générale", cex = 1, col = 1, pos = 4) 
text(2.2, 2.78, "moyenne pour A", cex = 1, col = 2, pos = 4) 
text(2.2, 4.9, "moyenne pour B", cex = 1, col = 3, pos = 4) 
text(2.2, 5.2, "moyenne pour C", cex = 1, col = 4, pos = 4) 
```


\columnsend


### ANOVA à un facteur - Rappel 3

- Calcul des sommes des carrés (inter- et intragroupes)

_i_ = indice des observations au sein du jeu de données de 1 à _n_,
_j_ = facteurs (sous-populations de 1 à _p_),
$\bar{y_j}$ = moyenne de la _j_^ème^ population:

$$
\begin{aligned}
S_{inter} = \sum_{i=1}^n{(\bar{y_j} - \bar{y})^2} && S_{intra} = \sum_{i=1}^n{(y_{ij} - \bar{y_j})^2}
\end{aligned}
$$

- Association du nombre de degrés de liberté :
    * _p_ – 1 pour l’intergroupe
    * _n_ – _p_ pour l’intragroupe

- Construction du \alert{tableau de l’ANOVA} :

| Type            |    Ddl    | Somme carrés | Carré moyen (_CM_)  |       Statistique _F_~obs~       | P (>_F_) |
|:----------------|:---------:|:------------:|:-------------------:|:----------------------------------:|:-----:|
| Inter (facteur) | _p_ - 1   | _S~inter~_ | _S~inter~/ddl~inter~_ | _CM~inter~/CM~intra~_ |  ...  |
| Intra (résidus) | _n_ - _p_ | _S~intra~_  | _S~intra~/ddl~intra~_ |  |  |

- Calcul de la **statistique _F_~obs~ comme le rapport des carrés moyens.**


### La distribution _F_ - Rappel

\columnsbegin
\columnsmall

- Distribution \alert{asymétrique}, n’admettant que des valeurs nulles ou positives.

\alert{La zone de rejet a une aire égale au seuil $\alpha$ choisi}

\alert{Il suffit de positionner la valeur de $F_{\textrm{obs}}$ sur le graphe pour savoir où l’on se situe}

\columnlarge

```{r, fig.width = 4.5, fig.height = 4, echo = FALSE, message = FALSE, warning = FALSE}
par(bg = "white")
# Fisher-Snedecor's F distribution (density probability) with parameter:
.df1 <- 5; .df2 <- 20 # numerator (.df1) and denominator (.df2) df
.col <- 1; .add <- FALSE # Plot parameters
.x <- seq(0, qf(0.999, df1 = .df1, df2 = .df2), l = 1000)  # Quantiles
.d <- function(x) df(x, df1 = .df1, df2 = .df2)            # Distribution function
.q <- function(p) qf(p, df1 = .df1, df2 = .df2)            # Quantile for lower-tail prob
.label <- bquote(F(.(.df1), .(.df2)))                      # Curve parameters
curve(.d(x), xlim = range(.x), xaxs = "i", n = 1000, col = .col,
  add = .add, xlab = "Quantiles", ylab = "Probability density") # Curve
abline(h = 0, col = "gray") # Baseline

# Upper-tail probability (right area)
.p2 <- 0.05; .x2 <- .x[.x >= .q(1 - .p2)]
polygon(c(.x2, max(.x2), min(.x2)), .d(c(.x2, -Inf, -Inf)),
  border = .col, col = "salmon")

# Add annotations
arrows(2, 0.38, 1.2, 0.3, length = 0.1, lwd = 1.5)
text(3.5, 0.4, labels = expression(paste("Zone de non rejet de ", H[0])))
arrows(3.5, 0.08, 3, 0.015, length = 0.1, lwd = 1.5)
text(4, 0.1, labels = expression(paste("Zone de rejet de ", H[0])))
```

\columnsend

- **Deux paramètres :** les degrés de liberté au numérateur et au dénominateur (ici = _ddl~inter~_ et _ddl~intra~_, respectivement).

- Plus le quantile est grand, plus la part de variance _inter_ est forte par rapport à la variance _intra_... donc, **plus on aura tendance à suspecter H~0~ (pour la rejeter lorsque _p_ < $\alpha$).**


### ANOVA à un facteur - Conditions d'application

- Modèle correspondant :

$$y_{ij}=\mu+\tau_j+\epsilon_{ij}$$

avec : $\tau_j$ = cste et $\epsilon_{ij}$ ~ N(0, $\sigma$) = \alert{résidus (residuals)}

- **Conditions d’application du test :**
    * échantillon aléatoire,
    * observations indépendantes,
    * variable \alert{réponse} quantitative,
    * une variable \alert{explicative} qualitative à 3 niveaux ou plus,
    * distribution \alert{normale} des résidus,
    * \alert{homoscédasticité} (même variance intragroupes, \alert{homoscedasticity} en anglais opposé à \alert{hétéroscédasticité} = variance différente entre les groupes).


### Vérification de la normalité des résidus

\columnsbegin
\columnsmall

- Résidus = $y_ij-\bar{y_j}$

- Graphe \alert{quantile–quantile}

Si les points s’alignent le long d’une droite, les quantiles respectifs correspondent

**=> la distribution observée se conforme à la distribution théorique**

\columnlarge

```{r, fig.width = 4.5, fig.height = 4.5, echo = FALSE, message = FALSE, warning = FALSE}
data(trees)
lm. <- lm(Volume ~Girth, data = trees)
library("dplyr")
library("ggplot2")
#plot(lm., which = 2)
lm. %>% qplot(sample = .stdresid, data = .) +
  geom_abline(intercept = 0, slope = 1, colour = "darkgray") +
  xlab("Theoretical quantiles") +
  ylab("Standardized residuals") +
  ggtitle("Normal Q-Q")
```

\columnsend


### Test de l'homoscédasticité
Différents tests d’hypothèse existent (Batlett, Levene, etc.).

- Les hypothèses sont :

**H~0~: homoscédasticité => var~1~ = var~2~ = ... = var~p~**

**H~1~: hétéroscédasticité => au moins une variance différente**


### Rejet de H~0~ - Tests de comparaisons multiples

- Si H~0~ n’est pas rejetée, pas de problèmes, on considère que les moyennes ne sont pas significativement différentes les unes des autres au seuil $\alpha$

- Si, par contre, H~0~ est rejetée, \alert{nous ne savons pas encore quelle(s)
moyenne(s) est(sont) différente(s) des autres}. Pour cela, il faut encore réaliser une **comparaison multiple des moyennes** (dit aussi **test _post hoc_**, car il doit nécessairement être précédé de l’ANOVA).
    * Le test le plus simple est celui de \alert{Bonferroni}. Il consiste à effectuer des tests de Student 2 à 2, mais en apportant une correction au seuil $\alpha$ utilisé par chaque test individuel.
    * Le test de \alert{Sheffé} est une alternative, mais très conservatif (et peu utilisé)
    * Le meilleur test est celui de \alert{Tukey} (implémenté dans R).
    * **Pour mémoire :** pour des comparaisons à un témoin, on peut utiliser le test de \alert{Dunnet} (pas dans R).


### ANOVA à un facteur - Démonstration

- \alert{Iris}, étude de la longueur des pétales en fonction de l'espèce.

\vfill

- Résolution de l’exemple dans R (démo...).

\vfill

- **Pour mémoire :** **dans R, le modèle de l’ANOVA à un facteur s’écrit :**

$$\textrm{Reponse} \sim \textrm{Facteur}$$

- _Attention aux tranformations éventuellement nécessaires pour l'homoscédasticité et la distribution normale des résidus !_


# ANOVA à deux facteurs

### ANOVA à deux facteurs

- \alert{Extrêmement varié} : de nombreux modèles différents existent (facteurs fixes ou aléatoires, plan balancé ou non, avec ou sans réplicas, facteurs imbriqués, etc.)

- \alert{Expérience/analyse factorielle (factorial analysis)}. Permet plus que de tester deux facteurs simultanément : permet aussi de déterminer s’il y a des \alert{interactions} entre les deux facteurs (variations différentes du facteur B pour les différents niveaux du facteur A).

- Exemple d’un jeu de données connu : \alert{ToothGrowth} => facteur A = substitut alimentaire, facteur B = dose.

- Distinction entre \alert{plan balancé} et \alert{non balancé} : le plan balancé est à la fois plus puissant et plus facile à calculer. Donc, il vaut mieux essayer d’obtenir le même nombre d’observations par niveau, autant que possible.

#### Attention

Il faut des vrais réplicas pas des \alert{pseudo-réplicas} !


### ANOVA à deux facteurs croisés sans réplicas

- Le manque de réplicas ne nous permet pas d’étudier les interactions entre les deux facteurs... nous devons considérer ici qu’elles n’existent pas (mais l'analyse sera incorrecte si cette hypothèse est fausse)!

- $y_{ijk} = \mu + \tau_{1j} + \tau_{2k} + \epsilon_{ijk}$

- $\epsilon_{ijk}$ ~ N(0, $\sigma$) = \alert{résidus (residuals)}

- **Dans R, le modèle s’écrit :**

$$\textrm{Reponse} \sim \textrm{Facteur1} + \textrm{Facteur2}$$


### ANOVA à deux facteurs croisés sans réplicas - Exemple

- Rendement de blé (tonnes/ha) : 4 variétés testés dans 3 fermes :

|         | Variété A | Variété B | Variété C | Variété D |
|:--------|:---------:|:---------:|:---------:|:---------:|
| Ferme X |   0.327   |   0.500   |   0.442   |   0.471   |
| Ferme Y |   0.532   |   0.599   |   0.516   |   0.638   |
| Ferme Z |   0.269   |   0.308   |   0.241   |   0.305   |


### ANOVA à deux facteurs croisés avec réplicas

- Cette fois-ci, on peut étudier les interactions

- $y_{ijk} = \mu + \tau_{1j} + \tau_{2k} + \tau_{1j}.\tau_{2k} + \epsilon_{ijk}$

- $\epsilon_{ijk}$ ~ N(0, $\sigma$) = \alert{résidus (residuals)}

- **Dans R, le modèle s’écrit :**

$$\textrm{Reponse} \sim \textrm{Facteur1} + \textrm{Facteur2} + \textrm{Facteur1}:\textrm{Facteur2}$$

ou en abbrégé :

$$\textrm{Reponse} \sim \textrm{Facteur1} * \textrm{Facteur2}$$


### ANOVA à deux facteurs croisés avec réplicas - Exemple

- Rendement de blé (tonnes/ha) : 4 variétés testés dans 3 fermes :

|         | Variété A | Variété B | Variété C | Variété D |
|:--------|:---------:|:---------:|:---------:|:---------:|
| Ferme X |   0.327   |   0.500   |   0.442   |   0.471   |
|         |   0.280   |   0.510   |   0.463   |   0.460   |
| Ferme Y |   0.532   |   0.599   |   0.516   |   0.638   |
|         |   0.526   |   0.637   |   0.499   |   0.655   |
| Ferme Z |   0.269   |   0.308   |   0.241   |   0.305   |
|         |   0.277   |   0.286   |   0.228   |   0.314   |


### ANOVA à deux facteurs hiérarchisés

- Un facteur est \alert{imbriqué dans l’autre (hierarchically nested factor)}

- $y_{ijk} = \mu + \tau_{1j} + \tau_{2k}(\tau_{1j}) + \epsilon_{ijk}$

- $\epsilon_{ijk}$ ~ N(0, $\sigma$) = \alert{résidus (residuals)}

- **Dans R, le modèle s’écrit :**

$$\textrm{Reponse} \sim \textrm{Facteur1} + \textrm{Facteur2} ~ \textrm{\%in\%} ~ \textrm{Facteur1}$$


### ANOVA à deux facteurs hiérarchisés - Exemple

- Mesures de contamination bactérienne de différentes eaux par différents étudiants (un étudiant mesure une seule eau 3 fois) :

|  Eaux   |         Mesure 1           |          Mesure 2            |
|:--------|:---------------------------|:-----------------------------|
| Egout   | (ét. A) 2700 / 2800 / 1700 | (ét. B) 2600 / 3000 / 3200   |
| Polluée | (ét. C) 52 / 49 / 61       | (ét. D) 68 / 75 / 83         |
| Propre  | (ét. E) 5.9 / 7.6 / 16.0   | (ét. F) 5.6 / 5.9 / 6.3      |
